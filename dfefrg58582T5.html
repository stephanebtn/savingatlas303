<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transmission Audio â€“ Agent 404</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="container">
    <!-- Intro -->
    <div id="intro">
      <p id="introText">Connexion au canal 404Î”...<br><small>(Appuyez pour activer)</small></p>
      <div class="glitch-lines"></div>
      <audio id="introSound" src="assets/signal.mp3" preload="auto"></audio>
    </div>
    <!-- Transmission -->
    <div class="terminal">
      <h1 id="title">Transmission entrante</h1>
      <div class="player-container" id="mainContent">
        <p>Canal : <strong>404-Î”</strong></p>
        <audio id="audio" controls preload="auto">
          <source src="assets/dfefrg58582T5.mp3" type="audio/mpeg" />
          Votre navigateur ne supporte pas la lecture audio.
        </audio>
      </div>
      <!-- Consignes -->
      <div id="endMessage" class="hidden" aria-live="polite">
        <h3>Vous avez trouvÃ© le fragment 5 !</h3>
	<h4>Signature dÃ©tectÃ©e : INGWAZ </h4>
      </div>
    </div>
    <div class="footer">Bureau de Sauvegarde Temporelle â€“ 2050</div>
  </div>
  <script>
// === Configuration ===
const WORKER_URL = "https://a303.stephane-btn.workers.dev";

// === Description du fragment ===
// âš ï¸ A CHANGER pour chaque page diffÃ©rente
const fragmentId = "fragment_5"; // Unique: fragment_1, fragment_2, fragment_3...

// === DÃ©tection de l'Ã©quipe ===
const params = new URLSearchParams(window.location.search);
const team = params.get("team") || "UNKNOWN";

const intro = document.getElementById('intro');
const introSound = document.getElementById('introSound');
const mainContent = document.getElementById('mainContent');
const title = document.getElementById('title');
const audioMain = document.getElementById('audio');
const endMessage = document.getElementById('endMessage');
let introPlayed = false;

// === Fonction d'envoi de notification ===
async function sendNotification() {
  const url = `${WORKER_URL}?team=${team}&fragment=${fragmentId}`;
  await fetch(url);
}
intro.addEventListener("click", async () => {
  if (introPlayed) return;
  introPlayed = true;
  
  try {
    await introSound.play();
  } catch (err) {
    console.warn("Lecture intro bloquÃ©e :", err);
  }
  
  introSound.addEventListener("ended", () => {
    intro.style.opacity = 0;
    title.style.opacity = 1;
    setTimeout(() => {
      intro.style.display = "none";
      mainContent.style.opacity = 1;
      audioMain.play().catch(e => console.warn("Lecture automatique bloquÃ©e :", e));
    }, 1500);
  });
});

// ðŸŽµ MODIFIÃ‰: Notification envoyÃ©e APRÃˆS la fin de la lecture du fragment audio
audioMain.addEventListener("ended", () => {
  console.log('ðŸŽµ Fragment audio terminÃ©');
  
  // Affiche le message de fin
  setTimeout(() => {
    endMessage.classList.remove('hidden');
    requestAnimationFrame(() => {
      endMessage.classList.add('fade-in');
    });
  }, 1000);
  
  // ðŸ“¤ Envoie la notification MAINTENANT (aprÃ¨s la lecture)
  sendNotification();
});

  </script>
</body>
</html>