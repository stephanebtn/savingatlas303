<!doctype html>
<html lang="fr">
<head>
<link rel="manifest" href="manifest.json">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Machine d'Interpr√©tation Lexicale ‚Äì BST-404</title>

  <style>
  :root{
  --bg:#000;
  --cyan:#0ff;
  --cyan-dim:#099;
  --scan:#0ff;
}
    html,body{
  height:100%;
  margin:0;
  font-family: "Share Tech Mono", monospace;
  background:#000;
  color:var(--cyan);
  display:flex;
  align-items:center;
  justify-content:center;
}

    .wrapper{ width:100%; height:100vh; display:flex; align-items:center; justify-content:center; }
    .device {
  width:92vw;
  max-width:520px;
  background: rgba(0,255,255,0.05);
  border:1px solid var(--cyan);
  border-radius:12px;
  padding:18px;
  box-shadow:0 0 18px rgba(0,255,255,0.3),
             inset 0 0 12px rgba(0,255,255,0.15);
  display:flex;
  flex-direction:column;
  gap:14px;
  align-items:center;
}

    .header {
      width:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:6px;
    }
    .title{
  font-size:1.1rem;
  color:var(--cyan);
  text-shadow:0 0 8px var(--cyan);
  letter-spacing:2px;
  text-transform:uppercase;
}
    .subtitle{
  font-size:0.8rem;
  color:var(--cyan-dim);
  text-shadow:0 0 4px var(--cyan-dim);
}

   .screen{
  width:100%;
  background:rgba(0,255,255,0.08);
  border:1px solid var(--cyan);
  border-radius:10px;
  padding:12px;
  min-height:140px;
  color:var(--cyan);
  font-size:14px;
  line-height:1.4;
  position:relative;
  box-shadow:0 0 18px rgba(0,255,255,0.25);
}

    .screen::after{
  content:"";
  position:absolute; inset:0;
  background-image:repeating-linear-gradient(
    0deg,
    rgba(0,255,255,0.12) 0px,
    rgba(0,255,255,0.12) 1px,
    transparent 1px,
    transparent 3px
  );
  pointer-events:none;
  mix-blend-mode:overlay;
}

    .console{
  white-space:pre-wrap;
  overflow:hidden;
  max-height:220px;
  text-shadow:0 0 6px var(--cyan);
}

    .controls {
      width:100%;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      margin-top:6px;
    }

    input[type="text"], input[type="password"]{
  width:86%;
  padding:12px;
  border-radius:10px;
  background:transparent;
  border:1px solid var(--cyan);
  color:var(--cyan);
  font-size:16px;
  text-transform:uppercase;
  text-align:center;
  outline:none;
  box-shadow:0 0 12px rgba(0,255,255,0.3);
}
input[type="text"]::placeholder, input[type="password"]::placeholder{
  color:var(--cyan-dim);
}
    .row {
      width:100%;
      display:flex;
      justify-content:center;
      gap:10px;
    }

    button{
  padding:10px 16px;
  border-radius:10px;
  background:rgba(0,255,255,0.12);
  border:1px solid var(--cyan);
  color:var(--cyan);
  font-weight:700;
  cursor:pointer;
  font-size:15px;
  text-shadow:0 0 6px var(--cyan);
  box-shadow:0 0 10px rgba(0,255,255,0.4);
}

button:hover{
  background:rgba(0,255,255,0.25);
  box-shadow:0 0 12px var(--cyan);
}

button:disabled{
  opacity:0.5;
  cursor:not-allowed;
}

    .status{
  width:88%;
  text-align:center;
  padding:8px 10px;
  border-radius:8px;
  font-size:13px;
}

.status.ok{
  color:var(--cyan);
  background:rgba(0,255,255,0.12);
  text-shadow:0 0 6px var(--cyan);
}

.status.err{
  color:#f00;
  background:rgba(255,0,0,0.1);
  text-shadow:0 0 6px #f00;
}

   .footer{
  width:100%;
  display:flex;
  justify-content:space-between;
  font-size:12px;
  color:var(--cyan-dim);
  border-top:1px solid rgba(0,255,255,0.2);
  padding-top:6px;
  margin-top:6px;
  text-shadow:0 0 4px var(--cyan-dim);
}

    .team-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,255,255,0.2);
      border: 1px solid var(--cyan);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
    }

    .lock-icon {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 20px;
      color: var(--cyan);
      text-shadow: 0 0 8px var(--cyan);
    }

    .locked-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .unlock-panel {
      width: 90%;
      max-width: 400px;
      background: rgba(0,255,255,0.05);
      border: 2px solid var(--cyan);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 0 30px rgba(0,255,255,0.5);
      text-align: center;
    }

    .unlock-title {
      font-size: 1.3rem;
      color: var(--cyan);
      text-shadow: 0 0 10px var(--cyan);
      margin-bottom: 10px;
      letter-spacing: 2px;
    }

    .unlock-subtitle {
      font-size: 0.85rem;
      color: var(--cyan-dim);
      margin-bottom: 25px;
    }

    .unlock-input {
      width: 100%;
      padding: 15px;
      margin-bottom: 15px;
      background: rgba(0,0,0,0.5);
      border: 1px solid var(--cyan);
      border-radius: 8px;
      color: var(--cyan);
      font-size: 18px;
      text-align: center;
      letter-spacing: 3px;
      font-family: "Share Tech Mono", monospace;
    }

    .unlock-btn {
      width: 100%;
      padding: 15px;
      background: rgba(0,255,255,0.15);
      border: 2px solid var(--cyan);
      border-radius: 8px;
      color: var(--cyan);
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      text-shadow: 0 0 8px var(--cyan);
      box-shadow: 0 0 15px rgba(0,255,255,0.4);
      font-family: "Share Tech Mono", monospace;
    }

    .unlock-btn:hover {
      background: rgba(0,255,255,0.25);
      box-shadow: 0 0 20px var(--cyan);
    }

    .unlock-error {
      color: #f00;
      margin-top: 10px;
      font-size: 0.9rem;
      text-shadow: 0 0 6px #f00;
      min-height: 20px;
    }

    @keyframes shake { 0%{transform:translateX(0)}20%{transform:translateX(-6px)}40%{transform:translateX(6px)}60%{transform:translateX(-4px)}80%{transform:translateX(2px)}100%{transform:translateX(0)} }

    @media (min-width:680px){
      .device{ max-width:480px; }
    }
  </style>
</head>

<body>
  <!-- √âcran de verrouillage -->
  <div id="lockScreen" class="locked-overlay">
    <div class="unlock-panel">
      <div class="unlock-title">üîí TERMINAL VERROUILL√â</div>
      <div class="unlock-subtitle">Sous-syst√®me BST-404 ¬∑ Acc√®s restreint</div>
      <input 
        type="password" 
        id="passwordInput" 
        class="unlock-input" 
        placeholder="MOT DE PASSE"
        maxlength="20"
        autocomplete="off"
      />
      <button id="unlockBtn" class="unlock-btn">D√âVERROUILLER</button>
      <div id="unlockError" class="unlock-error"></div>
    </div>
  </div>

  <audio id="ambience" preload="auto" loop></audio>
  <audio id="fx" preload="auto"></audio>
  <audio id="voice" preload="auto"></audio>

  <div class="wrapper">
    <div class="device" role="application" aria-label="Machine d'Interpr√©tation Lexicale BST-404">
      <div class="lock-icon" id="lockIcon">üîì</div>
      <div class="team-indicator" id="teamIndicator">TEAM: --</div>
      
      <div class="header">
        <div class="title">
          Machine d'Interpr√©tation Lexicale
        </div>
        <div class="subtitle">Machine non homologu√©e - Manuels de bord restreints.</div>
      </div>

      <div class="screen" id="screen" aria-live="polite">
        <div class="console" id="console">
[BOOT] Initialisation du sous-syst√®me BST-404...
[BOOT] Chargement du dictionnaire lexical...
[BOOT] Chargement de l'interpr√©teur s√©mantique...
[BOOT] Synchronisation temporelle : stable
[√âTAT] Scanner pr√™t.
        </div>
      </div>

      <div class="controls">
        <div style="display:flex;gap:8px;align-items:center;">
            <div style="font-size:13px;color:var(--muted)">Saisir un mot-cl√© connu par le dispositif</div>
        </div>

        <div class="row">
          <input id="decodeInput" type="text" placeholder="ENTRER LE MOT-CL√â" autocomplete="off" />
        </div>
        <div class="row">
          <button id="decodeBtn">D√âCODER</button>
        </div>

        <div id="status" class="status" role="status" aria-live="polite"></div>
      </div>

      <div class="footer">
        <div> Sous-syst√®me BST-404 </div>
        <div> Firmware v2.0-cf </div>
      </div>
    </div>
  </div>

  <audio id="soundOk" src="assets/ok.mp3" preload="auto"></audio>
  <audio id="soundError" src="assets/error.mp3" preload="auto"></audio>
  <audio id="soundScan" src="assets/scan.mp3" preload="auto"></audio>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>

// ====== CONFIGURATION ======
const urlParams = new URLSearchParams(location.search);
const TEAM = urlParams.get("team") || "NONE";

// üîß CONFIGUREZ VOTRE URL WORKER ICI
const WORKER_URL = "https://a303.stephane-btn.workers.dev";

// üîí CONFIGURATION DU MOT DE PASSE
// Changez "locked=true" en "locked=false" pour d√©sactiver le verrouillage
const IS_LOCKED = urlParams.get("locked") !== "false"; // Par d√©faut: verrouill√©
const PASSWORD = "ATLASFUNKY303"; // ‚ö†Ô∏è CHANGEZ LE MOT DE PASSE ICI

// Affichage de l'√©quipe
document.getElementById("teamIndicator").textContent = `TEAM: ${TEAM}`;

// ====== SYST√àME DE D√âVERROUILLAGE ======
const lockScreen = document.getElementById('lockScreen');
const passwordInput = document.getElementById('passwordInput');
const unlockBtn = document.getElementById('unlockBtn');
const unlockError = document.getElementById('unlockError');
const lockIcon = document.getElementById('lockIcon');

let isUnlocked = !IS_LOCKED; // Si pas verrouill√©, d√©j√† d√©verrouill√©

if (!IS_LOCKED) {
  // Terminal non verrouill√©, cacher l'√©cran de verrouillage
  lockScreen.style.display = 'none';
  console.log('[SYST√àME] üîì Terminal d√©verrouill√© par d√©faut');
} else {
  console.log('[SYST√àME] üîí Terminal verrouill√© - Mot de passe requis');
  lockIcon.textContent = 'üîí';
  passwordInput.focus();
}

function attemptUnlock() {
  const enteredPassword = passwordInput.value.trim().toUpperCase().replace(/\s+/g, ''); // Retire TOUS les espaces
  const correctPassword = PASSWORD.toUpperCase().replace(/\s+/g, '');
  
  if (enteredPassword === correctPassword) {
    // Mot de passe correct
    unlockError.style.color = 'var(--cyan)';
    unlockError.textContent = '‚úì ACC√àS AUTORIS√â';
    
    play(sOk);
    
    setTimeout(() => {
      lockScreen.style.opacity = '0';
      lockScreen.style.transition = 'opacity 0.5s';
      
      setTimeout(() => {
        lockScreen.style.display = 'none';
        isUnlocked = true;
        lockIcon.textContent = 'üîì';
        console.log('[SYST√àME] üîì Terminal d√©verrouill√© avec succ√®s');
        
        // D√©marre le boot
        const bootText =
          "[BOOT] Initialisation du sous-syst√®me BST-404...\n" +
          "[BOOT] Chargement du dictionnaire lexical...\n" +
          "[BOOT] Interpr√©teur s√©mantique op√©rationnel...\n" +
          "[BOOT] Synchronisation temporelle : OK\n" +
          `[SYST√àME] √âquipe d√©tect√©e: ${TEAM}\n` +
          `[R√âSEAU] Worker: ${WORKER_URL !== "https://votre-worker.workers.dev" ? "‚úì " + WORKER_URL : "‚ö† Non configur√©"}\n` +
          "[√âTAT] Scanner pr√™t.\n";
        writeConsole(bootText, true);
        input.focus();
        
        // üî• D√âMARRE LE POLLING MAINTENANT
        startPolling();
      }, 500);
    }, 1000);
    
  } else {
    // Mot de passe incorrect
    unlockError.style.color = '#f00';
    unlockError.textContent = '‚úó MOT DE PASSE INCORRECT';
    
    play(sErr);
    
    const panel = document.querySelector('.unlock-panel');
    panel.style.animation = 'shake 0.3s';
    setTimeout(() => panel.style.animation = '', 300);
    
    passwordInput.value = '';
    passwordInput.focus();
  }
}

unlockBtn.addEventListener('click', attemptUnlock);
passwordInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') attemptUnlock();
});

// ====== ROUTES (mot -> page) ======
const ROUTES = {
  "CECILE": "https://stephanebtn.github.io/savingatlas303/anniv0845.html",
  "ANNIVERSAIRE": "https://stephanebtn.github.io/savingatlas303/anniv0956.html"
};

// ====== √âTAT DU TERMINAL ======
let isOfflineMode = false;
let horizonEnabled = false;
let timerInterval = null;
let remainingTime = 600; // 10 minutes en secondes

// ====== AUDIO ======
const ambience = document.getElementById("ambience");
const fx = document.getElementById("fx");
const voice = document.getElementById("voice");
const sOk = document.getElementById('soundOk');
const sErr = document.getElementById('soundError');
const sScan = document.getElementById('soundScan');

function playAmbience(n) {
  ambience.src = `audio/ambience${n}.mp3`;
  ambience.play().catch(e => console.log("Audio play error:", e));
}

function playFx(n) {
  fx.src = `audio/fx${n}.mp3`;
  fx.play().catch(e => console.log("Audio play error:", e));
}

function playVoice(n) {
  voice.src = `audio/agent${n}.mp3`;
  voice.play().catch(e => console.log("Audio play error:", e));
}

function play(audio) {
  if (!audio) return;
  try {
    audio.currentTime = 0;
    audio.play().catch(() => {});
  } catch (e) {}
}

// ====== S√âQUENCE DE PASSAGE EN MODE HORS-LIGNE ======
async function enterOfflineMode() {
  console.log('üì¥ PASSAGE EN MODE HORS-LIGNE');
  
  isOfflineMode = true;
  
  // Affiche le message
  const offlineText = `[PROTOCOL 7X-B] D√©tection : Effondrement de Trame
[√âTAT] Proc√©dure d'Urgence : ACTIV√âE
[SYST√àME] Passage en Mode Hors-Ligne‚Ä¶

[DIRECTIVE] Ins√©rez les Modules CST dans l'interface.
[LIGNE] Analyse de coh√©rence en attente‚Ä¶`;

  writeConsole(offlineText, false, () => {
    // Active HORIZON et d√©marre le timer apr√®s l'affichage du message
    horizonEnabled = true;
    startTimer();
  });
}

// ====== TIMER ======
function startTimer() {
  const statusEl = document.getElementById('status');
  statusEl.className = "status ok";
  statusEl.style.display = "flex";
  
  timerInterval = setInterval(() => {
    remainingTime--;
    
    const minutes = Math.floor(remainingTime / 60);
    const seconds = remainingTime % 60;
    statusEl.textContent = `‚è± TEMPS RESTANT : ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    
    if (remainingTime <= 0) {
      clearInterval(timerInterval);
      statusEl.textContent = "‚è± TEMPS √âCOUL√â";
    }
  }, 1000);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  const statusEl = document.getElementById('status');
  statusEl.style.display = "none";
}
async function executeReboot() {
  console.log('üîÑ D√âBUT S√âQUENCE REBOOT');
  
  const wrapper = document.querySelector('.wrapper');
  const device = document.querySelector('.device');
  const screen = document.getElementById('screen');
  const consoleEl = document.getElementById('console');
  
  // D√©sactive tous les contr√¥les
  input.disabled = true;
  btn.disabled = true;
  
  // ========================================
  // PHASE 1: BRUIT STATIQUE (5 secondes)
  // ========================================
  console.log('üì∫ Phase 1: Bruit statique');
  
  // Cache tout sauf l'√©cran
  document.querySelector('.header').style.display = 'none';
  document.querySelector('.controls').style.display = 'none';
  document.querySelector('.footer').style.display = 'none';
  document.querySelector('.team-indicator').style.display = 'none';
  document.querySelector('.lock-icon').style.display = 'none';
  
  // Agrandit l'√©cran pour prendre tout l'espace
  device.style.width = '100vw';
  device.style.maxWidth = '100vw';
  device.style.height = '100vh';
  device.style.padding = '0';
  device.style.border = 'none';
  screen.style.width = '100%';
  screen.style.height = '100%';
  screen.style.border = 'none';
  screen.style.borderRadius = '0';
  
  // G√©n√®re le bruit visuel
  consoleEl.innerHTML = '';
  screen.style.background = 'rgba(255,255,255,0.1)';
  
  let noiseInterval = setInterval(() => {
    let noise = '';
    for (let i = 0; i < 1200; i++) {
      noise += String.fromCharCode(Math.random() > 0.5 ? 9608 : 9617);
    }
    consoleEl.textContent = noise;
  }, 50);
  
  // Son de bruit statique
  fx.src = 'audio/static.mp3';
  fx.loop = true;
  fx.play().catch(() => {});
  
  await new Promise(resolve => setTimeout(resolve, 5000));
  
  // ========================================
  // PHASE 2: √âCRAN NOIR + CURSEUR (5 secondes)
  // ========================================
  console.log('‚ö´ Phase 2: √âcran noir + curseur');
  clearInterval(noiseInterval);
  fx.pause();
  fx.loop = false;
  
  // √âcran totalement noir
  screen.style.background = '#000';
  consoleEl.innerHTML = '<span style="animation: blink 1s infinite;">‚ñà</span>';
  
  // Ajoute l'animation de clignotement
  const style = document.createElement('style');
  style.textContent = `
    @keyframes blink {
      0%, 49% { opacity: 1; }
      50%, 100% { opacity: 0; }
    }
  `;
  document.head.appendChild(style);
  
  await new Promise(resolve => setTimeout(resolve, 5000));
  
  // ========================================
  // PHASE 3: MESSAGES CENTR√âS
  // ========================================
  console.log('üí´ Phase 3: Messages syst√®me');
  
  consoleEl.style.display = 'flex';
  consoleEl.style.alignItems = 'center';
  consoleEl.style.justifyContent = 'center';
  consoleEl.style.textAlign = 'center';
  consoleEl.style.fontSize = '1.2rem';
  consoleEl.style.height = '100%';
  
  // Message 1
  consoleEl.innerHTML = 'Anomalie temporelle d√©tect√©e . . .';
  await new Promise(resolve => setTimeout(resolve, 3000));
  
  // Message 2
  consoleEl.innerHTML = 'S√©quence de r√©initialisation enclench√©e . . .';
  await new Promise(resolve => setTimeout(resolve, 3000));
  
  // Message 3: √âcran noir + curseur
  consoleEl.innerHTML = '<span style="animation: blink 1s infinite;">‚ñà</span>';
  await new Promise(resolve => setTimeout(resolve, 3000));
  
  // ========================================
  // PHASE 4: DIAGNOSTIC
  // ========================================
  console.log('üîç Phase 4: Diagnostic');
  
  consoleEl.style.fontSize = '1rem';
  consoleEl.style.textAlign = 'left';
  consoleEl.style.padding = '40px';
  
  const diagnosticLines = [
    'S√©quence de diagnostic :',
    '',
    '> Sous-syst√®me 304D00E . . . . . . . . . . [ ACTIF ]',
    '> Agent 404 . . . . . . . . . . . . . . . . [ INJOIGNABLE ]',
    '> Nouvelle trame temporelle d√©tect√©e . . . [ 2050-Œ© ]',
    '',
    'Transmission du dernier message de l\'Agent 404',
  ];
  
  consoleEl.innerHTML = '';
  for (let i = 0; i < diagnosticLines.length; i++) {
    consoleEl.innerHTML += diagnosticLines[i] + '\n';
    await new Promise(resolve => setTimeout(resolve, 800));
  }
  
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  // ========================================
  // PHASE 5: √âCRAN NOIR
  // ========================================
  console.log('‚ö´ Phase 5: √âcran noir');
  consoleEl.innerHTML = '';
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  // ========================================
  // PHASE 6: D√âCRYPTAGE (3 sec avec curseur clignotant)
  // ========================================
  console.log('üîì Phase 6: D√©cryptage');
  
  consoleEl.style.textAlign = 'center';
  consoleEl.style.fontSize = '1.1rem';
  consoleEl.style.display = 'flex';
  consoleEl.style.alignItems = 'center';
  consoleEl.style.justifyContent = 'center';
  
  consoleEl.innerHTML = 'Veuillez patienter . . .<br><br>D√©cryption en cours . . .<br><br><span style="animation: blink 1s infinite;">‚ñà</span>';
  await new Promise(resolve => setTimeout(resolve, 3000));
  
  // ========================================
  // PHASE 7: MESSAGE AUDIO (avec curseur clignotant)
  // ========================================
  console.log('üéôÔ∏è Phase 7: Message final');
  
  consoleEl.innerHTML = '[ TRANSMISSION EN COURS ]<br><br><span style="animation: blink 1s infinite;">‚ñà</span>';
  
  voice.src = 'audio/final_message.mp3';
  voice.play().catch(() => {});
  
  // Optionnel: R√©initialiser l'interface apr√®s le message
  voice.addEventListener('ended', () => {
    consoleEl.innerHTML = '[ FIN DE TRANSMISSION ]<br><br>‚Äî Agent 404 ‚Äî';
  }, { once: true });
}

// ====== SYST√àME DE COMMANDES √Ä DISTANCE VIA CLOUDFLARE ======
let lastCommandId = null;
let checkCount = 0;

async function checkCommands() {
  if (TEAM === "NONE") return;
  
  checkCount++;
  const url = `${WORKER_URL}/audio/get?team=${TEAM}`;
  
  try {
    console.log(`[${checkCount}] üîç V√©rification commandes... ${url}`);
    
    const response = await fetch(url);
    
    console.log(`[${checkCount}] üì° R√©ponse HTTP:`, response.status);
    
    if (!response.ok) {
      console.error(`[${checkCount}] ‚ùå Erreur HTTP ${response.status}`);
      return;
    }
    
    const data = await response.json();
    console.log(`[${checkCount}] üì¶ Donn√©es:`, data);
    
    if (data.command) {
      if (data.id !== lastCommandId) {
        lastCommandId = data.id;
        
        console.log(`[${checkCount}] üéµ NOUVELLE COMMANDE: ${data.command} (ID: ${data.id})`);
        
        // üîÑ COMMANDE SP√âCIALE: REBOOT
        if (data.command === "reboot") {
          console.log(`[${checkCount}] üîÑ COMMANDE REBOOT RE√áUE`);
          
          // Efface la commande imm√©diatement
          const clearUrl = `${WORKER_URL}/audio/clear?team=${TEAM}&id=${data.id}`;
          await fetch(clearUrl, { method: 'DELETE' });
          
          // Lance la s√©quence de reboot
          executeReboot();
          return; // Sort de la fonction
        }
        
        // üì¥ COMMANDE SP√âCIALE: OFFLINE (passage en mode hors-ligne)
        if (data.command === "offline") {
          console.log(`[${checkCount}] üì¥ COMMANDE OFFLINE RE√áUE`);
          
          // Efface la commande imm√©diatement
          const clearUrl = `${WORKER_URL}/audio/clear?team=${TEAM}&id=${data.id}`;
          await fetch(clearUrl, { method: 'DELETE' });
          
          // Lance le passage en mode hors-ligne
          enterOfflineMode();
          return;
        }
        
        // üéµ GESTION DES COMMANDES MULTIPLES (s√©par√©es par virgule)
        const commands = data.command.split(',');
        
        for (const cmd of commands) {
          const command = cmd.trim();
          
          // Ex√©cuter les commandes audio
          if (command.startsWith("amb")) {
            const num = command.replace("amb", "");
            console.log(`[${checkCount}] üéµ Lecture ambiance ${num}`);
            playAmbience(num);
          } else if (command.startsWith("fx")) {
            const num = command.replace("fx", "");
            console.log(`[${checkCount}] üîä Lecture FX ${num}`);
            playFx(num);
          } else if (command.startsWith("voice")) {
            const num = command.replace("voice", "");
            console.log(`[${checkCount}] üéôÔ∏è Lecture voice ${num}`);
            playVoice(num);
          }
          
          // Petit d√©lai entre chaque commande (optionnel)
          if (commands.length > 1) {
            await new Promise(resolve => setTimeout(resolve, 200));
          }
        }
        
        // Efface la commande apr√®s lecture
        const clearUrl = `${WORKER_URL}/audio/clear?team=${TEAM}&id=${data.id}`;
        console.log(`[${checkCount}] üóëÔ∏è Effacement commande: ${clearUrl}`);
        
        const clearResponse = await fetch(clearUrl, { method: 'DELETE' });
        console.log(`[${checkCount}] ‚úÖ Commande effac√©e:`, clearResponse.status);
      } else {
        console.log(`[${checkCount}] ‚è≠Ô∏è Commande d√©j√† trait√©e (ID: ${data.id})`);
      }
    } else {
      console.log(`[${checkCount}] üí§ Aucune commande en attente`);
    }
  } catch (error) {
    console.error(`[${checkCount}] ‚ö†Ô∏è Erreur:`, error);
  }
}

// ====== D√âMARRAGE DU SYST√àME DE POLLING ======
function startPolling() {
  if (TEAM !== "NONE" && WORKER_URL !== "https://votre-worker.workers.dev") {
    setInterval(checkCommands, 2000);
    console.log(`[SYST√àME] üéß √âcoute des commandes pour TEAM ${TEAM}`);
    console.log(`[SYST√àME] üåê Worker URL: ${WORKER_URL}`);
    console.log(`[SYST√àME] ‚úÖ Polling d√©marr√© (intervalle: 2s)`);
    
    // Premier check imm√©diat
    setTimeout(checkCommands, 500);
  } else if (WORKER_URL === "https://votre-worker.workers.dev") {
    console.warn('‚ö†Ô∏è WORKER_URL non configur√© !');
  }
}

// D√©marre le polling si d√©j√† d√©verrouill√©
if (isUnlocked) {
  startPolling();
}

// ====== UI ======
const input = document.getElementById('decodeInput');
const btn = document.getElementById('decodeBtn');
const consoleEl = document.getElementById('console');
const statusEl = document.getElementById('status');

let currentInterval = null;
let qrTimeout = null;

function writeConsole(text, fast = false, onFinish = null) {
  const base = fast ? 10 : 30;
  if (currentInterval) {
    clearInterval(currentInterval);
  }
  consoleEl.textContent = '';
  let i = 0;
  currentInterval = setInterval(() => {
    consoleEl.textContent += text[i] || "";
    i++;
    if (i > text.length) {
      clearInterval(currentInterval);
      currentInterval = null;
      if (onFinish) onFinish();
    }
  }, base);
}

function randomGarbage(len = 80) {
  const chars = "!@#$%^&*()_+{}[]<>?/|~-=0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  let s = "";
  for (let i = 0; i < len; i++) s += chars[Math.floor(Math.random() * chars.length)];
  return s;
}

function analyseWord(word) {
  const key = word.trim().toUpperCase();
  
  // ====== MODE HORS-LIGNE : Seul HORIZON est accept√© ======
  if (isOfflineMode) {
    if (key === "HORIZON") {
      if (horizonEnabled) {
        executeHorizonSequence();
        return;
      } else {
        statusEl.className = "status err";
        statusEl.style.display = "flex";
        statusEl.textContent = "ERREUR ‚Äî MOT-CL√â NON DISPONIBLE";
        play(sErr);
        
        const dev = document.querySelector('.device');
        dev.style.animation = "shake 0.28s";
        setTimeout(() => dev.style.animation = "", 300);
        
        writeConsole("[ERREUR] HORIZON ‚Äî ACC√àS REFUS√â\n[DIRECTIVE] Ins√©rez les Modules CST.");
        return;
      }
    } else {
      // En mode hors-ligne, tous les autres mots-cl√©s sont d√©sactiv√©s
      statusEl.className = "status err";
      statusEl.style.display = "flex";
      statusEl.textContent = "SYST√àME HORS-LIGNE ‚Äî FONCTION D√âSACTIV√âE";
      play(sErr);
      
      const dev = document.querySelector('.device');
      dev.style.animation = "shake 0.28s";
      setTimeout(() => dev.style.animation = "", 300);
      
      writeConsole("[SYST√àME] Mode Hors-Ligne actif\n[DIRECTIVE] Utilisez les Modules CST.");
      return;
    }
  }
  
  // ====== MODE NORMAL : Analyse des mots-cl√©s standards ======
  writeConsole("[ANALYSE] Interpr√©tation lexicale en cours...\n[CORR] " + randomGarbage(64));
  play(sScan);

  let pct = 4;
  const tick = setInterval(() => {
    pct += Math.floor(Math.random() * 10) + 4;
    if (pct > 98) pct = 99;
    consoleEl.textContent = "[ANALYSE] Interpr√©tation lexicale en cours...\n[CORR] " + pct + "%";
  }, 260);

  setTimeout(() => {
    clearInterval(tick);
    if (ROUTES[key]) success(key);
    else fail(key);
  }, 1600);
}

function success(key) {
  statusEl.className = "status ok";
  statusEl.style.display = "flex";
  statusEl.textContent = "TERME AUTHENTIFI√â ‚Äì G√âN√âRATION DU QRCODE";
  play(sOk);

  if (currentInterval) {
    clearInterval(currentInterval);
    currentInterval = null;
  }

  writeConsole(
    "[TERME] " + key + " ‚Äì AUTHENTIFICATION VALID√âE\n" +
    "[QRCODE] Fragment encod√©‚Ä¶",
    false,
    () => {
      setTimeout(() => {
        // Construction de l'URL avec le param√®tre team
        let targetUrl = ROUTES[key];
        if (TEAM !== "NONE") {
          targetUrl += (targetUrl.includes('?') ? '&' : '?') + `team=${TEAM}`;
        }

        consoleEl.innerHTML =
          "<div id='qrWrap' style='display:flex;justify-content:center;margin:10px 0;'></div>" +
          "\n[SCANNER] Pr√©sentez un appareil compatible.\n" +
          "[TEMPS] Retour automatique dans 30 secondes‚Ä¶";

        let qrDiv = document.getElementById('qrWrap');

        new QRCode(qrDiv, {
          text: targetUrl,
          width: 190,
          height: 190,
          colorDark: "#0ff",
          colorLight: "#000",
          correctLevel: QRCode.CorrectLevel.H
        });

        currentInterval = null;

        if (qrTimeout) {
          clearTimeout(qrTimeout);
          qrTimeout = null;
        }

        qrTimeout = setTimeout(() => {
          statusEl.style.display = "none";
          writeConsole("[√âTAT] Scanner pr√™t.\n");
          qrTimeout = null;
        }, 30000);

      }, 250);
    }
  );
}

function fail(key) {
  statusEl.className = "status err";
  statusEl.style.display = "flex";
  statusEl.textContent = "ERREUR LEXICALE ‚Äì AUCUNE CORRESPONDANCE";
  play(sErr);

  const dev = document.querySelector('.device');
  dev.style.animation = "shake 0.28s";
  setTimeout(() => dev.style.animation = "", 300);

  writeConsole("[ERREUR] " + key + " ‚Äì TERMINE INCONNU\n[RESET] Remise √† z√©ro‚Ä¶");

  setTimeout(() => {
    statusEl.style.display = "none";
    writeConsole("[√âTAT] Scanner pr√™t.\n");
  }, 2500);
}

btn.addEventListener('click', () => {
  const v = input.value || "";
  if (!v.trim()) {
    statusEl.className = "status err";
    statusEl.style.display = "flex";
    statusEl.textContent = "ERREUR ‚Äì AUCUN TERME FOURNI";
    play(sErr);

    const dev = document.querySelector('.device');
    dev.style.animation = "shake 0.28s";
    setTimeout(() => dev.style.animation = "", 300);

    writeConsole("[ERREUR] Remise √† z√©ro‚Ä¶");
    setTimeout(() => {
      statusEl.style.display = "none";
      writeConsole("[√âTAT] Scanner pr√™t.\n");
    }, 1800);
    return;
  }
  analyseWord(v);
});

input.addEventListener('keypress', (e) => {
  if (e.key === "Enter") btn.click();
});

window.addEventListener('load', () => {
  // Ne d√©marre le boot QUE si d√©j√† d√©verrouill√©
  if (isUnlocked) {
    input.focus();
    const bootText =
      "[BOOT] Initialisation du sous-syst√®me BST-404...\n" +
      "[BOOT] Chargement du dictionnaire lexical...\n" +
      "[BOOT] Interpr√©teur s√©mantique op√©rationnel...\n" +
      "[BOOT] Synchronisation temporelle : OK\n" +
      `[SYST√àME] √âquipe d√©tect√©e: ${TEAM}\n` +
      `[R√âSEAU] Worker: ${WORKER_URL !== "https://votre-worker.workers.dev" ? "‚úì " + WORKER_URL : "‚ö† Non configur√©"}\n` +
      "[√âTAT] Scanner pr√™t.\n";
    writeConsole(bootText, true);
    
    // D√©marre aussi le polling
    startPolling();
  }
});

  </script>
</body>
</html>
