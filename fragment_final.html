<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transmission Finale ‚Äì Agent 404</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div id="container">
    <!-- Intro -->
    <div id="intro">
      <p id="introText">Connexion au canal HORIZON...<br><small>(Appuyez pour activer)</small></p>
      <div class="glitch-lines"></div>
      <audio id="introSound" src="assets/signal.mp3" preload="auto"></audio>
    </div>
    
    <!-- Transmission -->
    <div class="terminal">
      <h1 id="title">Transmission Finale</h1>
      <div class="player-container" id="mainContent">
        <p>Canal : <strong>HORIZON</strong></p>
        <video id="video" controls preload="auto" style="width: 100%; max-width: 100%;">
          <source src="assets/final_fragment.mp4" type="video/mp4" />
          Votre navigateur ne supporte pas la lecture vid√©o.
        </video>
      </div>
      
      <!-- Consignes -->
      <div id="endMessage" class="hidden" aria-live="polite">
        <h3>Transmission termin√©e</h3>
      </div>
    </div>
    
    <div class="footer">Bureau de Sauvegarde Temporelle ‚Äì 2050</div>
  </div>

  <script>
// === Configuration ===
const WORKER_URL = "https://a303.stephane-btn.workers.dev"; // üîß CHANGEZ CETTE URL

// === D√©tection de l'√©quipe ===
const params = new URLSearchParams(window.location.search);
const team = params.get("team") || "UNKNOWN";

const intro = document.getElementById('intro');
const introSound = document.getElementById('introSound');
const mainContent = document.getElementById('mainContent');
const title = document.getElementById('title');
const videoMain = document.getElementById('video');
const endMessage = document.getElementById('endMessage');

let introPlayed = false;

// === Fonction d'enregistrement du fragment final ===
async function registerFinalFragment() {
  const url = `${WORKER_URL}?team=${team}&fragment=fragment_final_horizon`;
  
  console.log(`üì§ Enregistrement fragment final: Team ${team}`);
  
  try {
    const response = await fetch(url);
    if (response.ok) {
      console.log('‚úÖ Fragment final enregistr√©');
    } else {
      console.error('‚ùå Erreur enregistrement:', response.status);
    }
  } catch (error) {
    console.error('‚ùå Erreur r√©seau:', error);
  }
}

intro.addEventListener("click", async () => {
  if (introPlayed) return;
  introPlayed = true;
  
  try {
    await introSound.play();
  } catch (err) {
    console.warn("Lecture intro bloqu√©e :", err);
  }
  
  introSound.addEventListener("ended", () => {
    intro.style.opacity = 0;
    title.style.opacity = 1;
    
    setTimeout(() => {
      intro.style.display = "none";
      mainContent.style.opacity = 1;
      videoMain.play().catch(e => console.warn("Lecture automatique bloqu√©e :", e));
    }, 1500);
  });
});

// üé¨ Quand la vid√©o se termine
videoMain.addEventListener("ended", async () => {
  console.log('üé¨ Vid√©o termin√©e - Envoi commande FINAL au terminal');
  
  setTimeout(() => {
    endMessage.classList.remove('hidden');
    requestAnimationFrame(() => {
      endMessage.classList.add('fade-in');
    });
  }, 1000);
  
  // üìù Enregistre le fragment final dans le worker (pour le scoring)
  await registerFinalFragment();
  
  // üì§ Envoie la commande "final" au worker pour d√©clencher les directives finales
  try {
    const response = await fetch(`${WORKER_URL}/audio/send`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ 
        team: team, 
        command: 'final' 
      })
    });
    
    if (response.ok) {
      console.log('‚úÖ Commande FINAL envoy√©e avec succ√®s au terminal');
    } else {
      console.error('‚ùå Erreur envoi commande FINAL:', response.status);
    }
  } catch (error) {
    console.error('‚ùå Erreur r√©seau:', error);
  }
});
  </script>
</body>
</html>